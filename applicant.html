<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>My Profile â€¢ CaribCareerHub</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#F3F8FF; --panel:#ffffff; --ink:#0A2458; --muted:#6B7A99;
    --brand:#1E6CFF; --brand-2:#3FA2FF; --accent:#FFA03B;
    --radius:18px; --shadow:0 10px 30px rgba(16,40,120,0.12);
    --ring:0 0 0 3px rgba(30,108,255,.12);
  }
  body.dark{
    --bg:#0f1525; --panel:#111a2e; --ink:#ecf2ff; --muted:#b7c1d6;
    --brand:#5a8fff; --brand-2:#8ec4ff; --accent:#ffb86c;
    --shadow:0 14px 40px rgba(0,0,0,.45); --ring:0 0 0 3px rgba(142,196,255,.22);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow-x:hidden}

  /* Header */
  .header{max-width:1100px;margin:14px auto 0;padding:0 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:40px;height:40px;object-fit:contain}
  .brand-name{font-weight:900;letter-spacing:3px}
  .actions{display:flex;align-items:center;gap:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;font-weight:800;text-decoration:none;border:none;cursor:pointer}
  .btn-primary{color:#fff;background:linear-gradient(90deg,var(--brand),var(--brand-2));box-shadow:var(--shadow)}
  .btn-ghost{background:var(--panel);color:var(--ink);border:1px solid color-mix(in oklab, var(--ink) 12%, transparent)}
  .theme-toggle{min-width:44px}

  /* Shell */
  .panel{max-width:1100px;margin:16px auto 32px;padding:24px;border-radius:var(--radius);
    background:color-mix(in oklab, var(--panel) 90%, transparent);box-shadow:var(--shadow);
    border:1px solid color-mix(in oklab, var(--ink) 10%, transparent)}
  h1{margin:2px 0 14px;font-size:clamp(22px,4.5vw,30px);letter-spacing:.3px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:24px}
  @media (max-width: 900px){.grid{grid-template-columns:1fr}}

  /* Card */
  .card{background:var(--panel);border:1px solid color-mix(in oklab, var(--ink) 10%, transparent);
    border-radius:16px;padding:18px 16px;box-shadow:var(--shadow)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  label{font-weight:700;color:var(--muted);font-size:13px;margin-bottom:6px;display:block}
  input,textarea{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid color-mix(in oklab, var(--ink) 12%, transparent);
    background:transparent;color:var(--ink);font-size:16px;outline:none
  }
  input:focus,textarea:focus{box-shadow:var(--ring);border-color:color-mix(in oklab, var(--brand) 45%, transparent)}
  .hint{font-size:12px;color:var(--muted)}
  .kv{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .chip{font-size:12px;font-weight:800;color:var(--muted)}
  .list{display:grid;gap:10px;margin-top:8px}
  .job{border:1px solid color-mix(in oklab, var(--ink) 10%, transparent);border-radius:12px;padding:12px 14px}
  .job h4{margin:0 0 6px;font-size:16px}
  .job .meta{font-size:13px;color:var(--muted)}
  .cv-line{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .cv-link{font-weight:800;text-decoration:none;border-bottom:2px solid transparent}
  .cv-link:hover{border-color:color-mix(in oklab, var(--brand) 60%, transparent)}
  .ok{color:#0a7b32}.err{color:#b00020}
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <img src="./assets/logo.png" alt="CaribCareerHub" class="logo" />
    <div class="brand-name">CARRIBCAREERHUB</div>
  </div>
  <div class="actions">
    <button id="themeBtn" class="btn btn-ghost theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
    <a href="index.html" class="btn btn-ghost">Home</a>
    <button id="logoutBtn" class="btn btn-primary">Logout</button>
  </div>
</header>

<main class="panel">
  <h1>My Profile</h1>
  <div class="grid">
    <!-- LEFT: profile -->
    <section class="card">
      <h2 style="margin:0 0 12px;font-size:20px">Account & CV</h2>

      <div class="row">
        <div>
          <label for="full_name">Full name</label>
          <input id="full_name" placeholder="Jane Doe" />
        </div>
        <div>
          <label for="phone">Phone</label>
          <input id="phone" placeholder="+1 (876) 555â€‘1234" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="location">Location</label>
          <input id="location" placeholder="Kingston, Jamaica" />
        </div>
        <div>
          <label for="headline">Professional headline</label>
          <input id="headline" placeholder="Customer Support â€¢ 3+ yrs â€¢ CRM" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Email (login)</label>
        <div id="emailBox" class="chip">â€”</div>
      </div>

      <div style="margin-top:14px">
        <label>Resume / CV (PDF, DOCX)</label>
        <div class="cv-line">
          <input id="cvInput" type="file" accept=".pdf,.doc,.docx,.rtf" />
          <button id="cvUploadBtn" class="btn btn-ghost">Upload CV</button>
          <span id="cvStatus" class="hint"></span>
        </div>
        <div id="cvLinkWrap" style="margin-top:8px;display:none">
          <a id="cvLink" class="cv-link" target="_blank" rel="noopener">View latest CV</a>
        </div>
      </div>

      <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="saveBtn" class="btn btn-primary">Save Profile</button>
        <span id="saveMsg" class="hint"></span>
      </div>
    </section>

    <!-- RIGHT: applications -->
    <aside class="card">
      <div class="kv">
        <h2 style="margin:0;font-size:20px">My Applications</h2>
        <span id="appsCount" class="chip">0 total</span>
      </div>
      <div id="appsList" class="list" style="min-height:60px">
        <div class="hint">Loadingâ€¦</div>
      </div>
    </aside>
  </div>
</main>

<script type="module">
  // ====== CONFIG (your real values) ======
  const SUPABASE_URL = 'https://fpytvfhynleaivkvuedt.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweXR2Zmh5bmxlYWl2a3Z1ZWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzU1OTAsImV4cCI6MjA3MTI1MTU5MH0.Q7UHLIA_3_o7zCdV-IOthWOYGVVlINDXjp1uF4sdBRk';

  // ====== SUPABASE CLIENT ======
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

  // ====== THEME ======
  const themeBtn = document.getElementById('themeBtn');
  (function initTheme(){
    const saved = localStorage.getItem('cch.theme');
    if (saved === 'dark') document.body.classList.add('dark');
    if (!saved){
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) document.body.classList.add('dark');
      localStorage.setItem('cch.theme', document.body.classList.contains('dark')?'dark':'light');
    }
    themeBtn.textContent = document.body.classList.contains('dark') ? 'ðŸŒž' : 'ðŸŒ™';
    themeBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      localStorage.setItem('cch.theme', document.body.classList.contains('dark')?'dark':'light');
      themeBtn.textContent = document.body.classList.contains('dark') ? 'ðŸŒž' : 'ðŸŒ™';
    });
  })();

  // ====== AUTH GUARD ======
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const here = encodeURIComponent(location.href);
    location.href = `login.html?redirect=${here}`;
  }
  const user = (await sb.auth.getUser()).data.user;

  // UI refs
  const emailBox = document.getElementById('emailBox');
  const full_name = document.getElementById('full_name');
  const phone = document.getElementById('phone');
  const locationInput = document.getElementById('location');
  const headline = document.getElementById('headline');
  const cvInput = document.getElementById('cvInput');
  const cvUploadBtn = document.getElementById('cvUploadBtn');
  const cvStatus = document.getElementById('cvStatus');
  const cvLinkWrap = document.getElementById('cvLinkWrap');
  const cvLink = document.getElementById('cvLink');
  const saveBtn = document.getElementById('saveBtn');
  const saveMsg = document.getElementById('saveMsg');
  const logoutBtn = document.getElementById('logoutBtn');
  const appsList = document.getElementById('appsList');
  const appsCount = document.getElementById('appsCount');

  // Prefill
  emailBox.textContent = user?.email || 'â€”';
  const md = user?.user_metadata || {};
  full_name.value = md.full_name || '';
  phone.value = md.phone || '';
  locationInput.value = md.location || '';
  headline.value = md.headline || '';

  async function showCvLinkIfAny() {
    const latest = (await sb.auth.getUser()).data.user?.user_metadata?.cv_path;
    if (!latest) { cvLinkWrap.style.display = 'none'; return; }
    const { data, error } = await sb.storage.from('cv').createSignedUrl(latest, 60 * 60);
    if (error) { cvLinkWrap.style.display = 'none'; return; }
    cvLink.href = data.signedUrl;
    cvLinkWrap.style.display = 'block';
  }
  await showCvLinkIfAny();

  // Save profile
  saveBtn.addEventListener('click', async ()=>{
    saveBtn.disabled = true; saveMsg.textContent = 'Savingâ€¦';
    const { data, error } = await sb.auth.updateUser({
      data: {
        full_name: full_name.value.trim(),
        phone: phone.value.trim(),
        location: locationInput.value.trim(),
        headline: headline.value.trim()
      }
    });
    if (error) { saveMsg.textContent = 'Save failed'; saveMsg.className='hint err'; }
    else { saveMsg.textContent = 'Saved âœ”'; saveMsg.className='hint ok'; }
    saveBtn.disabled = false;
  });

  // Upload CV
  cvUploadBtn.addEventListener('click', async ()=>{
    const file = cvInput.files?.[0];
    if (!file) { cvStatus.textContent = 'Choose a file first'; cvStatus.className='hint err'; return; }
    cvStatus.textContent = 'Uploadingâ€¦'; cvStatus.className='hint';

    const safeName = file.name.replace(/[^\w.\-]+/g,'_');
    const path = `applications/${user.id}/${Date.now()}_${safeName}`;

    const { error: upErr } = await sb.storage.from('cv').upload(path, file, {
      cacheControl: '3600', upsert: false, contentType: file.type || 'application/octet-stream'
    });
    if (upErr) { cvStatus.textContent = 'Upload failed'; cvStatus.className='hint err'; return; }

    // store in user metadata for quick access
    const { error: mdErr } = await sb.auth.updateUser({ data: { cv_path: path } });
    if (mdErr) { cvStatus.textContent = 'Saved but link failed'; cvStatus.className='hint err'; }
    else { cvStatus.textContent = 'Uploaded âœ”'; cvStatus.className='hint ok'; await showCvLinkIfAny(); }
  });

  // Load applications (owned by user)
  async function loadApplications(){
    appsList.innerHTML = '<div class="hint">Loadingâ€¦</div>';
    let { data: apps, error } = await sb
      .from('applications')
      .select('*')
      .eq('applicant_id', user.id)
      .order('created_at', { ascending: false });

    if (error) { appsList.innerHTML = `<div class="hint err">Failed to load applications</div>`; return; }
    appsCount.textContent = `${apps.length} total`;

    if (!apps.length){
      appsList.innerHTML = `<div class="hint">No applications yet. Apply to a job to see it here.</div>`;
      return;
    }

    // Render; try to print best available job info
    appsList.innerHTML = apps.map(a=>{
      const title = a.job_title || a.title || 'Job';
      const company = a.company || a.company_name || '';
      const when = a.created_at ? new Date(a.created_at).toLocaleString() : '';
      const status = a.status || 'Submitted';
      return `
        <div class="job">
          <h4>${escapeHtml(title)}${company ? ` â€¢ ${escapeHtml(company)}`:''}</h4>
          <div class="meta">Applied: ${escapeHtml(when)} â€¢ Status: ${escapeHtml(status)}</div>
          ${a.cover_letter ? `<div class="meta" style="margin-top:6px">Cover letter: ${escapeHtml(a.cover_letter.slice(0,140))}${a.cover_letter.length>140?'â€¦':''}</div>`:''}
        </div>
      `;
    }).join('');
  }
  await loadApplications();

  // Logout
  logoutBtn.addEventListener('click', async ()=>{
    await sb.auth.signOut();
    location.href = 'login.html';
  });

  // Helpers
  function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}
</script>
</body>
</html>
