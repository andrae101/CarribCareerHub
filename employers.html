<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Employers ‚Ä¢ CaribCareerHub</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#F3F8FF; --panel:#ffffff; --ink:#0A2458; --muted:#6B7A99;
    --brand:#1E6CFF; --brand-2:#3FA2FF; --accent:#FFA03B;
    --radius:18px; --shadow:0 10px 30px rgba(16,40,120,0.12);
  }
  body.dark{
    --bg:#0e1424; --panel:#1c2333; --ink:#f4f6fb; --muted:#aab3cc;
    --brand:#3FA2FF; --brand-2:#1E6CFF; --accent:#ffb44d;
    --shadow:0 10px 30px rgba(0,0,0,.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}

  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:40px;height:40px;object-fit:contain}
  .brand b{letter-spacing:3px;white-space:nowrap}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn,.pill{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn{color:#fff;background:linear-gradient(90deg,var(--brand),var(--brand-2));box-shadow:var(--shadow)}
  .pill{background:var(--panel);color:var(--ink);border:1px solid color-mix(in oklab,var(--ink) 14%,transparent)}
  .pill.t{width:44px;text-align:center}

  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid color-mix(in oklab,var(--ink) 14%,transparent);background:var(--panel);font-weight:800;cursor:pointer}
  .tab.active{background:color-mix(in oklab,var(--brand) 18%,transparent);border-color:color-mix(in oklab,var(--brand) 38%,transparent)}

  .panel{background:var(--panel);border:1px solid color-mix(in oklab,var(--ink) 10%,transparent);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;grid-template-columns:300px 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .jobs{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto}
  .job{padding:12px;border:1px solid color-mix(in oklab,var(--ink) 10%,transparent);border-radius:12px;background:var(--panel);cursor:pointer}
  .job.active{outline:3px solid color-mix(in oklab,var(--brand) 40%,transparent)}
  .job small{color:var(--muted);font-weight:700}

  .apps h2{margin:4px 0 12px}
  .app{display:grid;gap:8px;padding:12px;border:1px solid color-mix(in oklab,var(--ink) 10%,transparent);border-radius:12px;background:var(--panel);margin-bottom:10px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-weight:700}
  .tag{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab,var(--ink) 16%,transparent)}
  .act{display:flex;gap:8px;flex-wrap:wrap}
  .small{font-size:13px}
  a.link{color:var(--brand);font-weight:800;text-decoration:none;border-bottom:2px solid transparent}
  a.link:hover{border-color:color-mix(in oklab,var(--brand) 40%,transparent)}
  .empty{color:var(--muted);font-weight:800;padding:16px;border:1px dashed color-mix(in oklab,var(--ink) 14%,transparent);border-radius:12px;text-align:center}

  .form{display:grid;gap:12px;max-width:720px}
  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  label{font-weight:800;color:var(--muted);font-size:13px}
  input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid color-mix(in oklab,var(--ink) 14%,transparent);background:var(--panel);color:var(--ink);font:inherit}
  textarea{min-height:120px;resize:vertical}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="brand">
        <img src="./assets/logo.png" alt="logo" />
        <b>CARRIBCAREERHUB</b>
      </div>
      <div class="actions">
        <button id="themeBtn" class="pill t" aria-label="Toggle theme">üåô</button>
        <a class="pill" href="index.html">Home</a>
        <button id="logoutBtn" class="pill">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="manage">Manage Applicants</button>
      <button class="tab" data-tab="post">Post Job</button>
      <button class="tab" data-tab="myjobs">My Jobs</button>
    </div>

    <section id="manage" class="panel">
      <div class="grid">
        <div>
          <h3 style="margin:4px 0 10px">Your Jobs</h3>
          <div id="jobs" class="jobs"><div class="empty">Loading‚Ä¶</div></div>
        </div>
        <div class="apps">
          <h2 id="jobTitle">Applicants</h2>
          <div id="apps"><div class="empty">Pick a job on the left to view applicants.</div></div>
        </div>
      </div>
    </section>

    <section id="post" class="panel" hidden>
      <h2 style="margin:4px 0 12px">Post a Job</h2>
      <form id="postForm" class="form">
        <div class="row">
          <div><label>Title</label><input id="title" required placeholder="e.g., Sales Manager" /></div>
          <div><label>Company</label><input id="company" placeholder="Your company" /></div>
        </div>
        <div class="row">
          <div><label>Location</label><input id="location" placeholder="e.g., Kingston, Jamaica" /></div>
          <div><label>Type</label><input id="type" placeholder="Full-time / Contract / Remote" /></div>
        </div>
        <div><label>Description</label><textarea id="desc" placeholder="Short description"></textarea></div>
        <button class="btn" type="submit">Publish Job</button>
        <div id="postMsg" class="small" style="margin-top:8px;color:var(--muted)"></div>
      </form>
    </section>

    <section id="myjobs" class="panel" hidden>
      <h2 style="margin:4px 0 12px">My Jobs</h2>
      <div id="jobsTable" class="jobs"><div class="empty">Loading‚Ä¶</div></div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase (your project)
    const SUPABASE_URL = 'https://fpytvfhynleaivkvuedt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZweXR2Zmh5bmxlYWl2a3Z1ZWR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzU1OTAsImV4cCI6MjA3MTI1MTU5MH0.Q7UHLIA_3_o7zCdV-IOthWOYGVVlINDXjp1uF4sdBRk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Theme
    (function themeInit(){
      const b = document.body, t = document.getElementById('themeBtn');
      const saved = localStorage.getItem('cch.theme');
      if (saved === 'dark') b.classList.add('dark');
      if (!saved){
        const prefers = matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefers) b.classList.add('dark');
        localStorage.setItem('cch.theme', b.classList.contains('dark') ? 'dark' : 'light');
      }
      t.textContent = b.classList.contains('dark') ? 'üåû' : 'üåô';
      t.onclick = ()=>{ b.classList.toggle('dark'); localStorage.setItem('cch.theme', b.classList.contains('dark') ? 'dark':'light'); t.textContent = b.classList.contains('dark') ? 'üåû':'üåô'; };
    })();

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const sections = { manage:document.getElementById('manage'), post:document.getElementById('post'), myjobs:document.getElementById('myjobs') };
    tabs.forEach(btn=>{
      btn.onclick = ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        Object.values(sections).forEach(s=>s.hidden=true);
        sections[btn.dataset.tab].hidden=false;
      };
    });

    // Auth guard
    let user = null;
    async function ensureAuth(){
      const { data:{ session }} = await sb.auth.getSession();
      if(!session){ location.href = 'login.html'; return; }
      user = session.user;
    }
    document.getElementById('logoutBtn').onclick = async()=>{ await sb.auth.signOut(); location.href='login.html'; };

    // Helpers
    const jobsEl = document.getElementById('jobs');
    const appsEl = document.getElementById('apps');
    const titleEl = document.getElementById('jobTitle');
    const jobsTable = document.getElementById('jobsTable');
    let currentJobId = null;
    const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    // Load employer jobs
    async function loadJobs(listAlsoToTable=false){
      jobsEl.innerHTML = '<div class="empty">Loading‚Ä¶</div>';
      const { data, error } = await sb.from('jobs')
        .select('id,title,company,created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(100);
      if(error){ jobsEl.innerHTML = '<div class="empty">Failed to load jobs.</div>'; return; }
      if(!data?.length){ jobsEl.innerHTML = '<div class="empty">No jobs yet. Use ‚ÄúPost Job‚Äù.</div>'; return; }

      jobsEl.innerHTML='';
      data.forEach(j=>{
        const div = document.createElement('div');
        div.className = 'job';
        div.dataset.id = j.id;
        div.innerHTML = `<b>${esc(j.title)}</b><br><small>${esc(j.company||'')}</small>`;
        div.onclick = ()=>{ document.querySelectorAll('.job').forEach(x=>x.classList.remove('active')); div.classList.add('active'); currentJobId=j.id; titleEl.textContent = 'Applicants ‚Ä¢ ' + j.title; loadApplicants(j.id); };
        jobsEl.appendChild(div);
      });

      if(listAlsoToTable){
        jobsTable.innerHTML='';
        data.forEach(j=>{
          const row = document.createElement('div');
          row.className = 'job';
          row.innerHTML = `<b>${esc(j.title)}</b><br><small>${esc(j.company||'')} ‚Ä¢ ${new Date(j.created_at).toLocaleString()}</small>`;
          jobsTable.appendChild(row);
        });
      }

      const first = jobsEl.querySelector('.job'); if(first) first.click();
    }

    // Load applicants for a job
    async function loadApplicants(jobId){
      appsEl.innerHTML = '<div class="empty">Loading applicants‚Ä¶</div>';
      const { data, error } = await sb.from('applications')
        .select('id,applicant_name,applicant_email,resume_url,cover_letter,status,created_at')
        .eq('job_id', jobId)
        .order('created_at', { ascending:false });
      if(error){ appsEl.innerHTML = '<div class="empty">Failed to load applicants.</div>'; return; }
      if(!data?.length){ appsEl.innerHTML = '<div class="empty">No applicants yet for this job.</div>'; return; }

      appsEl.innerHTML='';
      data.forEach(a=>{
        const card = document.createElement('div');
        card.className='app';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div>
              <b>${esc(a.applicant_name||'Applicant')}</b>
              <div class="meta small">
                <span class="tag">${new Date(a.created_at).toLocaleString()}</span>
                <span class="tag">${esc(a.applicant_email||'no email')}</span>
                <span class="tag">Status: <b class="st">${esc(a.status||'Reviewing')}</b></span>
              </div>
            </div>
            <div class="act">
              <button class="pill small" data-s="Reviewing">Reviewing</button>
              <button class="pill small" data-s="Interview">Interview</button>
              <button class="pill small" data-s="Hired">Hired</button>
              <button class="pill small" data-s="Rejected">Rejected</button>
              ${a.resume_url ? `<a class="link pill small" href="${esc(a.resume_url)}" target="_blank" rel="noopener">CV</a>` : ''}
            </div>
          </div>
          ${a.cover_letter ? `<div class="small" style="margin-top:8px;color:var(--muted)">${esc(a.cover_letter)}</div>`:''}
        `;
        card.querySelectorAll('button[data-s]').forEach(b=>{
          b.onclick = async()=>{
            const ns = b.dataset.s;
            const { error } = await sb.from('applications').update({ status: ns }).eq('id', a.id);
            if(error){ alert('Failed to update'); return; }
            card.querySelector('.st').textContent = ns;
          };
        });
        appsEl.appendChild(card);
      });
    }

    // Post job
    document.getElementById('postForm').onsubmit = async(e)=>{
      e.preventDefault();
      const msg = document.getElementById('postMsg');
      const title = document.getElementById('title').value.trim();
      const company = document.getElementById('company').value.trim();
      const location = document.getElementById('location').value.trim();
      const type = document.getElementById('type').value.trim();
      const desc = document.getElementById('desc').value.trim();
      if(!title){ msg.textContent='Title is required'; return; }
      msg.textContent = 'Saving‚Ä¶';
      const { error } = await sb.from('jobs').insert({
        title, company, location, type, description: desc, user_id: user.id
      });
      if(error){ msg.textContent='Failed to post job.'; return; }
      msg.textContent='Job posted!';
      e.target.reset();
      await loadJobs(true);
      document.querySelector('.tab[data-tab="manage"]').click();
    };

    // Boot
    (async function(){
      await ensureAuth();
      await loadJobs(true);
    })();
  </script>
</body>
</html>
